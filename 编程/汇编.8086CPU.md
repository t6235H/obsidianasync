#汇编 #基础 

==16位CPU==
- 地址总线的位数决定寻址能力
	- **地址总线**：是 CPU 与内存（或其他外设）之间传递地址信息的物理线路
	- **寻址能力**：指 CPU 能直接访问的最大内存空间大小（单位通常为字节）
	- 若地址总线宽度为 `n` 位，则最大寻址空间为 ==`2^n` 字节==（Byte）
	- - 32 位地址总线：`2^32 = 4,294,967,296 字节 = 4GB`
	- 64 位地址总线：理论上 `2^64 ≈ 18EB`（但实际受操作系统和硬件限制，通常支持到数百 GB）
	- **8086 处理器**：==20 位地址总线== → 最大寻址 `2^20 = 1MB` 内存
- **数据总线**：决定 “一次能传输多少数据”（数据传输效率）
	- 64 位数据总线一次可传输 8 字节（64 位）数据，而 32 位数据总线一次传输 4 字节
	- **8086 处理器**16位，所有寄存器都可以存放2字节
	- 8086上一代是8位，为了兼容它，AX,BX,CX,DX四个寄存器可以分为两个独立的8位使用：AH,AL  BH,BL  CH,CL  DH,DL   AX:4E20H  AH:4EH  AL:20H
- 8086CPU用两个16位地址合成了一个20位的地址，地址加法器将两个地址合并成20位地址
- 两个16位：一个叫段地址，一个叫偏移地址offset
- 物理地址=（段地址x16） + 偏移地址  
- 123C8H=**1000**0H+23C8H  偏移地址可取到FFFFH
- 123C8H=**1200**0H+03C8H  偏移地址可取到FFFH
- 123C8H=**1230**0H+00C8H  偏移地址可取到FFH
- 123C8H=**123C**0H+0008H  偏移地址可取到FH
- x16=>   ==16进制左移1位==     =>   2进制左移4位
-  ==偏移地址最大取值范围：0000H-FFFFH==  一个段的长度最大为2^16=64KB
- 段寄存器是提供段地址的寄存器
- 8086CPU有4个段寄存器：
- CS: code segment 代码段寄存器
- DS: data segment 数据段寄存器   DS+【偏移地址】= 内存单元
- SS: stack segment 栈 段 寄 存 器    SS+SP = 栈顶单元
- ES: extra segment 附加段寄存器
- IP: instruction pointer 指令指针寄存器     CS+IP 读取指令
- 8086CPU开机后，CS=FFFFH,IP=0000H。所以第一条指令是FFFF0H内存单元内的指令。
- 同时修改CS:IP的值： jmp 段地址：偏移地址
- jmp 2AE3:3   -> 2AE33H
- jmp 3:0B16   -> 00B46H
- 仅修改IP的值：jmp 合法寄存器
- mov ax,200H       jmp ax
- 定义代码段：可以将一组长度小于等于64KB的代码，存放到一组地址连续、长度为16的倍数的内存单元中
- 实践汇编：在DosBox中查看寄存器   [[大端序小端序]]
	- mount c d:\masm 把d:\masm挂载为c盘      c:  进入c盘  
	- 运行debug程序:
	- debug是dos、windows都提供的实模式(8086方式)程序的调试工具。
	- R命令：查看、改变寄存器的内容
	- D命令：查看内存的内容
	- E命令：改变内存的内容
	- U命令：将内存中的机器指令翻译成汇编指令
	- T命令：执行一条机器指令
	- A命令：用汇编在内存中写入一条机器指令
	- q quit:退出
	- G命令：断点  IP
	- P命令：执行完循环  
	- 显示缓冲区的地址范围:
	- 单色显示缓冲区的地址范围是 “B0000H - B0F9FH”
	- 彩色显示缓冲区的地址范围是 “B8000H - BFFFFH”
	- 字符与颜色的表示：每个字符占用 2 个字节，低字节存储 ASCII 码，高字节存储颜色属性
	- -e b810:0 48 02 65 02 6C 02 6C 02 6F 02
	- 屏幕左上角第一个字符位于 B8000H
- 栈
	- SS  栈顶的段地址
	- SP  栈顶的偏移地址
	- PUSH ==Decrements== the stack pointer and then ==stores== the source operand on the top of the stack. Address and operand sizes are determined and used as follows
	- POP ==Loads== the value from the top of the stack to the location specified with the destination operand (or explicit opcode) and then ==increments== the stack pointer. The destination operand can be a general-purpose register, memory location, or segment register.


| 低地址↓  |       | 10000H | 1D  | 栈空间  |
| ----- | ----- | ------ | --- | ---- |
|       |       | 10001H | 24  | 栈内存  |
|       |       | ...    | ... | 栈内存  |
|       |       | 1000EH | 63  | 栈内存  |
| 高地址   | 栈底↑   | 1000FH | E2  | 栈内存  |
| 初始化栈顶 | SS:SP | 10010H | B8  | 其他内存 |
|       |       | 10011H | 3C  | 其他内存 |


- 编写汇编代码


| ;Z=X+Y PROC                                                                                                                                                                                                                                        | ;  注释                                                                                         |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
|                                                                                                                                                                                                                                                    | .MODEL SMALL <br>定义内存模型（SMALL: 1 个代码段 + 1 个数据段                                                |
| ASSUME DS:DATA,SS:STACK,CS:CODE                                                                                                                                                                                                                    | 声明                                                                                            |
| data segment                                                                                                                                                                                                                                       | 数据段开始                                                                                         |
| X    DW 1234H                                                                                                                                                                                                                                      | 定义变量 X                                                                                        |
| Y    DW 2345H                                                                                                                                                                                                                                      | `DW`（Define Word）定义16位数据                                                                      |
| Z    DW ?                                                                                                                                                                                                                                          | 定义无初始值变量 Z                                                                                    |
| date ends                                                                                                                                                                                                                                          | 数据段结束                                                                                         |
| stack segment PARA STACK                                                                                                                                                                                                                           | 栈段开始<br>PARA表示段起始地址按 ​​16 字节（段落）对齐​（即段地址是 16 的倍数）<br>STACK表示这是一个 ​栈段​​（汇编器会特殊处理，如初始化 `SS:SP`） |
| DW 256 DUP(?) ; 定义 256 个字的栈空间（512 字节）                                                                                                                                                                                                              | 256 DUP(?) 重复256次 未初始化的数据                                                                     |
| stack ends                                                                                                                                                                                                                                         | 栈段结束                                                                                          |
|                                                                                                                                                                                                                                                    | .STACK 512 <br>直接定义 512 字节的栈（替代手动定义 SSEG）<br>.DATA ; 数据段<br>.CODE ; 代码段                       |
| code segment                                                                                                                                                                                                                                       | 段开始                                                                                           |
| main:                                                                                                                                                                                                                                              | 入口   MAIN PROC                                                                                |
| MOV    AX,DATA<br>         MOV    DS,AX<br><br>         MOV    AX,X<br>         PUSH   AX<br>         MOV    AX,Y<br>         PUSH   AX<br><br>         CALL   SUM<br>         MOV    Z,AX<br><br>		 mov ax,4c00H ;中断<br>		 int 21H            ;中断 | MOV AH, 09H ;DOS 功能号：显示字符串                                                                    |
| SUM PROC ;取两个栈顶元素，返回和储存到AX中<br>         MOV    BP,SP<br>         MOV    AX,[BP+2]<br>         ADD    AX,[BP+4]<br>         RET<br>SUM ENDP                                                                                                         |                                                                                               |
| mov ax,4c00H                                                                                                                                                                                                                                       | 中断                                                                                            |
| int 21H                                                                                                                                                                                                                                            | 中断  debug时，到了这里不用r,用p命令，会显示program terminated normally 程序正常停止                                 |
| code ends                                                                                                                                                                                                                                          | 段结束                                                                                           |
| end main                                                                                                                                                                                                                                           | 指定程序入口点 main                                                                                  |


`mov ax,0ffffh`汇编源代码中，==数字不能以字母开头==，所以要加0
`mov ax,ds:[2]`如果直接写`mov ax,[2]`是不行的，相当于`mov ax,2`。
`mov bx,2  mov ax,[bx]`
`mov bx,2  mov ax,ds:[bx]`


- masm 1.asm;
- link 1.obj;
- ml 1.asm;  ml = masm + link
- 1.exe
- debug 1.exe


| loop循环                                 |                                                 |
| -------------------------------------- | ----------------------------------------------- |
| mov cx,11<br>s: add ax,ax<br>   loop s | cx是循环次数<br>s 是标号<br>执行loop时，cx -1,如果cx不为0，就跳到s处 |


