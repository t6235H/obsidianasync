#rust #动态链接库 #dll #字符串 #c语言 
[[rust.导出dll给c语言，字符串]]

---

> [!note] 注意
> 1.Rust 的 DLL 返回的是指针，易语言需要用 `指针到文本()` 读取；
2.使用完后必须调用 `free_string(ptr)` 来释放内存，否则会内存泄漏；
3.Rust 编译需使用 `i686-pc-windows-gnu`，与易语言一致（32位）。
[[rust.i686-pc-windows-gnu是什么]]
4.易语言函数调用，默认使用 `stdcall` 或 `cdecl`  不加extern  "stdcall"不加会导致堆栈回收错误 → 就会报 **堆栈损坏或访问异常** （cdecl）
5.易语言编码是GBK，rust编码是utf-8,要对编码进行转换




- **易语言》插入》DLL命令**

| DLL命令名           | 返回值类型              | 公开  | 备注                              |           |
| ---------------- | ------------------ | --- | ------------------------------- | --------- |
| convert_to_yiyan | ==整数型==            |     | 命令名可以随便起；返回值是c语言的指针，所以是整数型      |           |
| 库文件名             | 在库中对应命令名           |     |                                 |           |
| rust_c_lib.dll   | convert_to_yiyuyan |     | 库文件名：只写名字，需要dll和源码在同一目录；可以写绝对路径 |           |
|                  |                    |     |                                 |           |
| 参数名              | 类型                 | 传值  | 数组                              | 备注        |
| 随便字符串            | ==文本型==            |     |                                 | dll接收的字符串 |

- **传入的参数为什么是==文本型==，而不是整数型？**
	易语言把 `文本型` 自动转成了 `char*`（ANSI 编码，带结尾 `\0`）
	Rust 拿到的就是 `*const c_char`，解析后进行逻辑转换

| DLL命令名         | 返回值类型                                            | 公开  | 备注                                                                                                             |                               |
| -------------- | ------------------------------------------------ | --- | -------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| 释放rust字符串      |                                                  |     |                                                                                                                |                               |
| 库文件名           | 在库中对应命令名                                         |     |                                                                                                                |                               |
| rust_c_lib.dll | free_rust_string<br>名字不能叫free_string,因为精易模块里有同名的 |     | 定义当前Dll命令在其所在动态或静态链接库中的名称，如果不指定，系统将默认等同于“Dll命令名”。如果本名称以"@"字符开始，表示本命令将采用==cdecl==调用方式，否则表示采用默认的==stdcall==调用方式。 | 易语言的提示里，把cdecl拼写错了，错误写法：edcel |
|                |                                                  |     |                                                                                                                |                               |
| 参数名            | 类型                                               | 传值  | 数组                                                                                                             | 备注                            |
| c的指针           | 整数型                                              |     |                                                                                                                | 要释放的内存                        |


```
.版本 2

.程序集 窗口程序集1

.子程序 入口
.版本 2

.局部变量 输入字符串, 文本型
.局部变量 结果文本, 文本型
.局部变量 结果指针, 整数型

输入字符串 ＝ 编辑框1.内容
结果指针 ＝ convert_to_yiyuyan (输入字符串)
结果文本 ＝ 指针到文本 (结果指针)
编辑框2.内容 ＝ 结果
free_string (结果指针)


```